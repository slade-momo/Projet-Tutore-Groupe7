{% extends "base.html" %}
{% load static %}

{% block title %}Prévisions IA - Ferme Mokpokpo{% endblock %}

{% block content %}
<!-- CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
.metric-card { box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.chart-container { max-height: 500px; overflow: hidden; }
.table-container { max-height: 400px; overflow-y: auto; }
.table-critique { background-color: #f8d7da !important; }
</style>

<div class="container-fluid py-4">
    <!-- HEADER -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-warehouse"></i> Ferme Mokpokpo - Stock Analytics
            </h1>
            <p class="lead text-muted">Prévisions IA Prophet • 2021-2028</p>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6">
            <div class="card metric-card bg-primary text-white text-center h-100">
                <div class="card-body">
                    <i class="fas fa-boxes fa-3x mb-3 opacity-75"></i>
                    <h2 class="display-6">{{ current_stock|floatformat:0 }}</h2>
                    <p class="mb-0 fw-bold fs-5">Stock Actuel</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card metric-card bg-success text-white text-center h-100">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-3x mb-3 opacity-75"></i>
                    <h2 class="display-6">{{ precision }}%</h2>
                    <p class="mb-0 fw-bold fs-5">Précision Modèle</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card metric-card bg-info text-white text-center h-100">
                <div class="card-body">
                    <i class="fas fa-hard-hat fa-3x mb-3 opacity-75"></i>
                    <h2 class="display-6">{{ capacite_max|floatformat:0 }}</h2>
                    <p class="mb-0 fw-bold fs-5">Capacité Maximum</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card metric-card bg-danger text-white text-center h-100">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3 opacity-75"></i>
                    <h2 class="display-6">{{ seuil_critique|floatformat:0 }}</h2>
                    <p class="mb-0 fw-bold fs-5">Seuil Critique</p>
                </div>
            </div>
        </div>
    </div>

    <!-- GRAPHIQUES PRINCIPAUX (fig1 + fig2 du Colab) -->
    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4><i class="fas fa-chart-area me-2"></i>Prévision Complète (fig1)</h4>
                </div>
                <div class="card-body p-2 chart-container">
                    {% if img_forecast %}
                        <img src="data:image/png;base64,{{ img_forecast }}" class="img-fluid rounded" alt="Prévision complète">
                    {% else %}
                        <div class="text-center p-5">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Graphique en cours de génération...</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-lg">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-cogs me-2"></i>Composants Prophet (fig2)</h5>
                </div>
                <div class="card-body p-2">
                    {% if img_components %}
                        <img src="data:image/png;base64,{{ img_components }}" class="img-fluid rounded" style="height: 400px;" alt="Composants">
                    {% else %}
                        <div class="text-center p-4 bg-light rounded">
                            <i class="fas fa-cogs fa-2x text-muted mb-2"></i>
                            <p class="text-muted small">Analyse saisonnalité</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- BARCHARTS 2026-2028 (EXACTS Colab) -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-danger text-white text-center">
                    <h5><i class="fas fa-calendar-alt"></i> 2026</h5>
                </div>
                <div class="card-body p-3">
                    {% if img_2026 %}
                        <img src="data:image/png;base64,{{ img_2026 }}" class="img-fluid rounded" alt="2026">
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-warning text-white text-center">
                    <h5><i class="fas fa-calendar-alt"></i> 2027</h5>
                </div>
                <div class="card-body p-3">
                    {% if img_2027 %}
                        <img src="data:image/png;base64,{{ img_2027 }}" class="img-fluid rounded" alt="2027">
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white text-center">
                    <h5><i class="fas fa-calendar-alt"></i> 2028</h5>
                </div>
                <div class="card-body p-3">
                    {% if img_2028 %}
                        <img src="data:image/png;base64,{{ img_2028 }}" class="img-fluid rounded" alt="2028">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- DONNÉES HISTORIQUES -->
    <div class="row g-4 mb-5">
        <div class="col-lg-6">
            <div class="card shadow-lg">
                <div class="card-header bg-secondary text-white">
                    <h5><i class="fas fa-history me-2"></i>Derniers 12 mois - df_stock</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive table-container">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Mois</th><th>Entrées</th><th>Sorties</th><th>Stock</th><th>Alerte</th><th>%Rempl.</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in historique_stock %}
                                <tr class="{% if item.alerte == 'CRITIQUE' %}table-danger table-critique{% else %}table-success{% endif %}">
                                    <td><strong>{{ item.ds|date:"M Y" }}</strong></td>
                                    <td>{{ item.entrees|floatformat:0 }}</td>
                                    <td>{{ item.sorties|floatformat:0 }}</td>
                                    <td class="fw-bold">{{ item.stock|floatformat:0 }}</td>
                                    <td>
                                        <span class="badge bg-{% if item.alerte == 'CRITIQUE' %}danger{% else %}success{% endif %} fs-6">
                                            {{ item.alerte }}
                                        </span>
                                    </td>
                                    <td>{{ item.remplissage|floatformat:1 }}%</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="6" class="text-center py-4 text-muted">Aucune donnée</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card shadow-lg">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-database me-2"></i>df_prophet (Format Prophet)</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr><th>Date</th><th>Stock (y)</th></tr>
                            </thead>
                            <tbody>
                                {% for item in historique_prophet %}
                                <tr>
                                    <td>{{ item.ds|date:"M Y" }}</td>
                                    <td class="fw-bold">{{ item.y|floatformat:0 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
