{% extends "base.html" %}
{% load static %}

{% block title %}Prévisions IA - Ferme Mokpokpo{% endblock %}
{% block page_title %}Prévisions IA{% endblock %}
{% block breadcrumbs %}<i class="fas fa-home"></i> <a href="{% url 'dashboard' %}">Accueil</a> / Prévisions IA{% endblock %}

{% block extra_css %}
<style>
    .chart-container { max-height: 500px; overflow: hidden; }
    .table-container { max-height: 400px; overflow-y: auto; }
    .table-critique { background-color: rgba(239,68,68,.06) !important; }
    .no-data-hero { padding: 80px 20px; text-align: center; }
    .no-data-hero i { font-size: 4rem; color: var(--clr-accent); opacity: .5; margin-bottom: 16px; }
    .data-badge { font-size: .75rem; padding: 2px 10px; border-radius: 20px;
        background: rgba(16,185,129,.1); color: #10b981; font-weight: 600; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- HEADER -->
    <div class="text-center mb-4">
        <h2 class="fw-bold" style="color: var(--clr-primary);">
            <i class="fas fa-brain" style="color: var(--clr-accent);"></i> Stock Analytics
        </h2>
        <p class="text-muted">
            Prévisions IA Prophet &bull;
            {% if date_range %}{{ date_range }}{% else %}Analyse en temps réel{% endif %}
            {% if nb_mois_historique %}
                <span class="data-badge ms-2">
                    <i class="fas fa-database"></i> {{ nb_mois_historique }} mois de données
                </span>
            {% endif %}
        </p>
    </div>

    {% if no_data %}
    <!-- PAS ASSEZ DE DONNÉES -->
    <div class="card">
        <div class="card-body no-data-hero">
            <i class="fas fa-database d-block"></i>
            <h4 class="fw-bold mb-3">Données insuffisantes pour la prévision</h4>
            <p class="text-muted mb-4" style="max-width: 500px; margin: 0 auto;">
                Le modèle Prophet nécessite au minimum 2 mois de données historiques
                (mouvements de stock, lots, ventes) pour générer des prévisions fiables.
            </p>
            <div class="row g-3 justify-content-center">
                <div class="col-auto">
                    <div class="stat-card" style="min-width: 180px;">
                        <div class="stat-icon" style="background: rgba(59,130,246,.1); color: #3b82f6;">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="number">{{ current_stock|floatformat:0 }}</div>
                        <div class="label">Stock Actuel (kg)</div>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="stat-card" style="min-width: 180px;">
                        <div class="stat-icon" style="background: rgba(6,182,212,.1); color: #06b6d4;">
                            <i class="fas fa-hard-hat"></i>
                        </div>
                        <div class="number">{{ capacite_max|floatformat:0 }}</div>
                        <div class="label">Capacité Max</div>
                    </div>
                </div>
            </div>
            <p class="text-muted mt-4" style="font-size: .85rem;">
                <i class="fas fa-info-circle"></i>
                Ajoutez des mouvements de stock, des lots et des ventes pour activer les prévisions.
            </p>
        </div>
    </div>
    {% else %}

    <!-- KPIs -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(59,130,246,.1); color: #3b82f6;">
                    <i class="fas fa-boxes"></i>
                </div>
                <div class="number">{{ current_stock|floatformat:0 }}</div>
                <div class="label">Stock Actuel</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(16,185,129,.1); color: #10b981;">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="number">{{ precision }}%</div>
                <div class="label">Précision Modèle</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(6,182,212,.1); color: #06b6d4;">
                    <i class="fas fa-hard-hat"></i>
                </div>
                <div class="number">{{ capacite_max|floatformat:0 }}</div>
                <div class="label">Capacité Maximum</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card" style="border-color: var(--clr-danger);">
                <div class="stat-icon" style="background: rgba(239,68,68,.1); color: #ef4444;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="number" style="color: var(--clr-danger);">{{ seuil_critique|floatformat:0 }}</div>
                <div class="label">Seuil Critique</div>
            </div>
        </div>
    </div>

    <!-- GRAPHIQUES PRINCIPAUX -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-area"></i>
                    <span>Prévision Complète</span>
                </div>
                <div class="card-body p-2 chart-container">
                    {% if img_forecast %}
                        <img src="data:image/png;base64,{{ img_forecast }}" class="img-fluid rounded" alt="Prévision complète">
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-chart-line d-block"></i>
                            <p>Graphique en cours de génération...</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cogs"></i>
                    <span>Composants Prophet</span>
                </div>
                <div class="card-body p-2">
                    {% if img_components %}
                        <img src="data:image/png;base64,{{ img_components }}" class="img-fluid rounded" style="max-height: 400px;" alt="Composants">
                    {% else %}
                        <div class="empty-state" style="padding:24px;">
                            <i class="fas fa-cogs d-block"></i>
                            <p>Analyse saisonnalité</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- BARCHARTS PRÉVISIONS PAR ANNÉE (dynamique) -->
    {% if year_forecasts %}
    <div class="row g-4 mb-4">
        {% for yf in year_forecasts %}
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-calendar-alt" style="color: {{ yf.color }} !important;"></i>
                    <span>Prévisions {{ yf.year }}</span>
                </div>
                <div class="card-body p-3">
                    {% if yf.img %}
                        <img src="data:image/png;base64,{{ yf.img }}" class="img-fluid rounded" alt="{{ yf.year }}">
                    {% else %}
                        <div class="empty-state" style="padding:24px;">
                            <i class="fas fa-chart-bar d-block"></i>
                            <p>Données non disponibles</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- DONNÉES HISTORIQUES -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-history"></i>
                    <span>Derniers 12 mois - Historique Stock</span>
                </div>
                <div class="table-responsive table-container">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Mois</th>
                                <th>Entrées</th>
                                <th>Sorties</th>
                                <th>Stock</th>
                                <th>Alerte</th>
                                <th>%Rempl.</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in historique_stock %}
                            <tr class="{% if item.alerte == 'CRITIQUE' %}table-critique{% endif %}">
                                <td class="fw-bold">{{ item.ds|date:"M Y" }}</td>
                                <td>{{ item.entrees|floatformat:0 }}</td>
                                <td>{{ item.sorties|floatformat:0 }}</td>
                                <td class="fw-bold">{{ item.stock|floatformat:0 }}</td>
                                <td>
                                    <span class="badge {% if item.alerte == 'CRITIQUE' %}bg-danger{% else %}bg-success{% endif %}">
                                        {{ item.alerte }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="progress flex-grow-1" style="height:4px; min-width:50px;">
                                            <div class="progress-bar {% if item.remplissage > 85 %}bg-danger{% elif item.remplissage > 60 %}bg-warning{% else %}bg-success{% endif %}" style="width: {{ item.remplissage }}%;"></div>
                                        </div>
                                        <span style="font-size:11px; min-width:36px;">{{ item.remplissage|floatformat:1 }}%</span>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6">
                                    <div class="empty-state" style="padding:24px;">
                                        <i class="fas fa-database d-block"></i>
                                        <p>Aucune donnée</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-database"></i>
                    <span>Format Prophet (ds / y)</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Stock (y)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in historique_prophet %}
                            <tr>
                                <td class="text-muted">{{ item.ds|date:"M Y" }}</td>
                                <td class="fw-bold">{{ item.y|floatformat:0 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2">
                                    <div class="empty-state" style="padding:24px;">
                                        <i class="fas fa-database d-block"></i>
                                        <p>Aucune donnée</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}
